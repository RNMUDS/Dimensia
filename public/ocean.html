<html>
  <head>
    <title>Ocean VR with Hand Tracking</title>
    <meta name="description" content="Ocean VR Experience with Hand Tracking">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/@c-frame/aframe-particle-system-component@1.2.x/dist/aframe-particle-system-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-simple-sun-sky@^1.2.2/simple-sun-sky.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-hand-tracking-controls@0.1.0/dist/aframe-hand-tracking-controls.min.js"></script>
  </head>
  <body>
    <a-scene webxr="optionalFeatures: hand-tracking">
        <a-sky color="black"></a-sky>
        
        <!-- Lights -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="point" position="0 10 5" color="#87cefa" intensity="0.5"></a-light>
        
        <!-- Ocean -->
        <a-entity id="ocean" ocean="density:1000; width: 500; depth: 500; speed: 0.1"
                  material="color: #87cefa; opacity: 0.1; metalness: 0.1; roughness: 0.1"
                  rotation="-90 0 0"></a-entity>
        
        <!-- Hand entities -->
        <a-entity id="leftHand" hand-tracking-controls="hand: left; modelStyle: mesh; modelColor: #ffdbac"></a-entity>
        <a-entity id="rightHand" hand-tracking-controls="hand: right; modelStyle: mesh; modelColor: #ffdbac"></a-entity>
        
        <!-- Custom hand visualization component -->
        <script>
          AFRAME.registerComponent('custom-hand-mesh', {
            schema: {
              hand: {type: 'string', default: 'right'}
            },
            
            init: function() {
              this.jointMeshes = {};
              this.boneConnections = [];
              
              // Define finger connections
              this.fingerConnections = [
                // Thumb
                ['wrist', 'thumb-metacarpal'],
                ['thumb-metacarpal', 'thumb-phalanx-proximal'],
                ['thumb-phalanx-proximal', 'thumb-phalanx-distal'],
                ['thumb-phalanx-distal', 'thumb-tip'],
                // Index finger
                ['wrist', 'index-finger-metacarpal'],
                ['index-finger-metacarpal', 'index-finger-phalanx-proximal'],
                ['index-finger-phalanx-proximal', 'index-finger-phalanx-intermediate'],
                ['index-finger-phalanx-intermediate', 'index-finger-phalanx-distal'],
                ['index-finger-phalanx-distal', 'index-finger-tip'],
                // Middle finger
                ['wrist', 'middle-finger-metacarpal'],
                ['middle-finger-metacarpal', 'middle-finger-phalanx-proximal'],
                ['middle-finger-phalanx-proximal', 'middle-finger-phalanx-intermediate'],
                ['middle-finger-phalanx-intermediate', 'middle-finger-phalanx-distal'],
                ['middle-finger-phalanx-distal', 'middle-finger-tip'],
                // Ring finger
                ['wrist', 'ring-finger-metacarpal'],
                ['ring-finger-metacarpal', 'ring-finger-phalanx-proximal'],
                ['ring-finger-phalanx-proximal', 'ring-finger-phalanx-intermediate'],
                ['ring-finger-phalanx-intermediate', 'ring-finger-phalanx-distal'],
                ['ring-finger-phalanx-distal', 'ring-finger-tip'],
                // Pinky finger
                ['wrist', 'pinky-finger-metacarpal'],
                ['pinky-finger-metacarpal', 'pinky-finger-phalanx-proximal'],
                ['pinky-finger-phalanx-proximal', 'pinky-finger-phalanx-intermediate'],
                ['pinky-finger-phalanx-intermediate', 'pinky-finger-phalanx-distal'],
                ['pinky-finger-phalanx-distal', 'pinky-finger-tip']
              ];
              
              // Create materials
              this.jointMaterial = new THREE.MeshPhongMaterial({
                color: 0xffdbac,
                emissive: 0xffdbac,
                emissiveIntensity: 0.1
              });
              
              this.boneMaterial = new THREE.MeshPhongMaterial({
                color: 0xffdbac,
                emissive: 0xffdbac,
                emissiveIntensity: 0.1
              });
              
              // Joint geometry (larger cubes)
              this.jointGeometry = new THREE.BoxGeometry(0.02, 0.02, 0.02); // 2倍の大きさ
              
              // Setup immediately and also on model-loaded
              setTimeout(() => this.setupHandMesh(), 1000);
              this.el.addEventListener('model-loaded', () => {
                this.setupHandMesh();
              });
            },
            
            setupHandMesh: function() {
              // Create meshes for all possible joints
              const jointNames = [
                'wrist', 'thumb-metacarpal', 'thumb-phalanx-proximal', 'thumb-phalanx-distal', 'thumb-tip',
                'index-finger-metacarpal', 'index-finger-phalanx-proximal', 'index-finger-phalanx-intermediate', 'index-finger-phalanx-distal', 'index-finger-tip',
                'middle-finger-metacarpal', 'middle-finger-phalanx-proximal', 'middle-finger-phalanx-intermediate', 'middle-finger-phalanx-distal', 'middle-finger-tip',
                'ring-finger-metacarpal', 'ring-finger-phalanx-proximal', 'ring-finger-phalanx-intermediate', 'ring-finger-phalanx-distal', 'ring-finger-tip',
                'pinky-finger-metacarpal', 'pinky-finger-phalanx-proximal', 'pinky-finger-phalanx-intermediate', 'pinky-finger-phalanx-distal', 'pinky-finger-tip'
              ];
              
              // Create joint meshes
              jointNames.forEach(jointName => {
                const mesh = new THREE.Mesh(this.jointGeometry, this.jointMaterial);
                mesh.visible = false;
                this.el.sceneEl.object3D.add(mesh);
                this.jointMeshes[jointName] = mesh;
              });
              
              // Create bone connections
              this.fingerConnections.forEach((connection, index) => {
                const cylinderGeometry = new THREE.CylinderGeometry(0.01, 0.01, 1, 8); // 太さ0.02（直径）
                const cylinder = new THREE.Mesh(cylinderGeometry, this.boneMaterial);
                cylinder.visible = false;
                this.el.sceneEl.object3D.add(cylinder);
                this.boneConnections[index] = cylinder;
              });
              
              this.handsReady = true;
            },
            
            tick: function() {
              if (!this.handsReady) return;
              
              const hand = this.el.components['hand-tracking-controls'];
              if (!hand || !hand.joints) return;
              
              const handObject3D = this.el.object3D;
              
              // Update joint positions
              for (const jointName in this.jointMeshes) {
                const joint = hand.joints[jointName];
                const mesh = this.jointMeshes[jointName];
                
                if (joint && mesh && joint.object3D) {
                  // Get world position and rotation
                  const worldPos = new THREE.Vector3();
                  const worldQuat = new THREE.Quaternion();
                  joint.object3D.getWorldPosition(worldPos);
                  joint.object3D.getWorldQuaternion(worldQuat);
                  
                  mesh.position.copy(worldPos);
                  mesh.quaternion.copy(worldQuat);
                  mesh.visible = true;
                }
              }
              
              // Update bone connections
              this.fingerConnections.forEach((connection, index) => {
                const [joint1Name, joint2Name] = connection;
                const joint1 = hand.joints[joint1Name];
                const joint2 = hand.joints[joint2Name];
                const cylinder = this.boneConnections[index];
                
                if (joint1 && joint2 && cylinder && joint1.object3D && joint2.object3D) {
                  const pos1 = new THREE.Vector3();
                  const pos2 = new THREE.Vector3();
                  joint1.object3D.getWorldPosition(pos1);
                  joint2.object3D.getWorldPosition(pos2);
                  
                  // Calculate midpoint
                  const midpoint = new THREE.Vector3();
                  midpoint.addVectors(pos1, pos2).multiplyScalar(0.5);
                  
                  // Calculate distance
                  const distance = pos1.distanceTo(pos2);
                  
                  // Update cylinder position and scale
                  cylinder.position.copy(midpoint);
                  cylinder.scale.y = distance;
                  
                  // Orient cylinder
                  const direction = new THREE.Vector3();
                  direction.subVectors(pos2, pos1).normalize();
                  const quaternion = new THREE.Quaternion();
                  quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction);
                  cylinder.quaternion.copy(quaternion);
                  
                  cylinder.visible = true;
                }
              });
            }
          });
          
          // Add custom hand mesh component to hand entities after scene loads
          document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
              document.querySelector('#leftHand').setAttribute('custom-hand-mesh', 'hand: left');
              document.querySelector('#rightHand').setAttribute('custom-hand-mesh', 'hand: right');
            }, 500);
          });
        </script>
        
        <!-- Camera rig for VR -->
        <a-entity id="cameraRig" position="0 1.6 0">
          <a-camera></a-camera>
        </a-entity>
        
        <!-- Add VR button -->
        <button id="vrButton" style="position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer; z-index: 999;">Enter VR</button>
        <script>
          const scene = document.querySelector('a-scene');
          const vrButton = document.querySelector('#vrButton');
          
          if (scene.hasLoaded) {
            onSceneLoaded();
          } else {
            scene.addEventListener('loaded', onSceneLoaded);
          }
          
          function onSceneLoaded() {
            vrButton.addEventListener('click', () => {
              scene.enterVR();
            });
          }
        </script>
    </a-scene>
  </body>
</html>